var A=Object.create;var d=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,x=Object.prototype.hasOwnProperty;var V=(a,e)=>{for(var t in e)d(a,t,{get:e[t],enumerable:!0})},w=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of T(e))!x.call(a,s)&&s!==t&&d(a,s,{get:()=>e[s],enumerable:!(r=v(e,s))||r.enumerable});return a};var k=(a,e,t)=>(t=a!=null?A(K(a)):{},w(e||!a||!a.__esModule?d(t,"default",{value:a,enumerable:!0}):t,a)),N=a=>w(d({},"__esModule",{value:!0}),a);var E={};V(E,{useStorage:()=>R});module.exports=N(E);var i=require("react");var C=k(require("pify"),1);var b=()=>{try{let e=(globalThis.navigator?.userAgent).match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(e[1]==="Chrome")return parseInt(e[2])<100||globalThis.chrome.runtime?.getManifest()?.manifest_version===2}catch{return!1}return!1};var f=class{#a;#e;get primaryClient(){return this.#e}#t;get secondaryClient(){return this.#t}#s;get area(){return this.#s}get hasWebApi(){try{return typeof window<"u"&&!!window.localStorage}catch(e){return console.error(e),!1}}#r=new Map;#n;get copiedKeySet(){return this.#n}isCopied=e=>this.hasWebApi&&(this.allCopied||this.copiedKeySet.has(e));#i=!1;get allCopied(){return this.#i}getExtStorageApi=()=>globalThis.browser?.storage||globalThis.chrome?.storage;get hasExtensionApi(){try{return!!this.getExtStorageApi()}catch(e){return console.error(e),!1}}isWatchSupported=()=>this.hasExtensionApi;keyNamespace="";isValidKey=e=>e.startsWith(this.keyNamespace);getNamespacedKey=e=>`${this.keyNamespace}${e}`;getUnnamespacedKey=e=>e.slice(this.keyNamespace.length);constructor({area:e="sync",allCopied:t=!1,copiedKeyList:r=[]}={}){this.setCopiedKeySet(r),this.#s=e,this.#i=t;try{this.hasWebApi&&(t||r.length>0)&&(this.#t=window.localStorage)}catch{}try{this.hasExtensionApi&&(this.#a=this.getExtStorageApi(),b()?this.#e=(0,C.default)(this.#a[this.area],{exclude:["getBytesInUse"],errorFirst:!1}):this.#e=this.#a[this.area])}catch{}}setCopiedKeySet(e){this.#n=new Set(e)}rawGetAll=()=>this.#e?.get();getAll=async()=>{let e=await this.rawGetAll();return Object.entries(e).filter(([t])=>this.isValidKey(t)).reduce((t,[r,s])=>(t[this.getUnnamespacedKey(r)]=s,t),{})};copy=async e=>{let t=e===void 0;if(!t&&!this.copiedKeySet.has(e)||!this.allCopied||!this.hasExtensionApi)return!1;let r=this.allCopied?await this.rawGetAll():await this.#e.get((t?[...this.copiedKeySet]:[e]).map(this.getNamespacedKey));if(!r)return!1;let s=!1;for(let n in r){let o=r[n],l=this.#t?.getItem(n);this.#t?.setItem(n,o),s||=o!==l}return s};rawGet=async e=>this.hasExtensionApi?(await this.#e.get(e))[e]:this.isCopied(e)?this.#t?.getItem(e):null;rawSet=async(e,t)=>(this.isCopied(e)&&this.#t?.setItem(e,t),this.hasExtensionApi&&await this.#e.set({[e]:t}),null);clear=async(e=!1)=>{e&&this.#t?.clear(),await this.#e.clear()};rawRemove=async e=>{this.isCopied(e)&&this.#t?.removeItem(e),this.hasExtensionApi&&await this.#e.remove(e)};removeAll=async()=>{let e=await this.getAll(),t=Object.keys(e);await Promise.all(t.map(this.remove))};watch=e=>{let t=this.isWatchSupported();return t&&this.#o(e),t};#o=e=>{for(let t in e){let r=this.getNamespacedKey(t),s=this.#r.get(r)?.callbackSet||new Set;if(s.add(e[t]),s.size>1)continue;let n=(o,l)=>{if(l!==this.area||!o[r])return;let h=this.#r.get(r);if(!h)throw new Error(`Storage comms does not exist for nsKey: ${r}`);Promise.all([this.parseValue(o[r].newValue),this.parseValue(o[r].oldValue)]).then(([u,p])=>{for(let m of h.callbackSet)m({newValue:u,oldValue:p},l)})};this.#a.onChanged.addListener(n),this.#r.set(r,{callbackSet:s,listener:n})}};unwatch=e=>{let t=this.isWatchSupported();return t&&this.#c(e),t};#c(e){for(let t in e){let r=this.getNamespacedKey(t),s=e[t],n=this.#r.get(r);n&&(n.callbackSet.delete(s),n.callbackSet.size===0&&(this.#r.delete(r),this.#a.onChanged.removeListener(n.listener)))}}unwatchAll=()=>this.#l();#l(){this.#r.forEach(({listener:e})=>this.#a.onChanged.removeListener(e)),this.#r.clear()}async getItem(e){return this.get(e)}async setItem(e,t){await this.set(e,t)}async removeItem(e){return this.remove(e)}},y=class extends f{get=async e=>{let t=this.getNamespacedKey(e),r=await this.rawGet(t);return this.parseValue(r)};set=async(e,t)=>{let r=this.getNamespacedKey(e),s=JSON.stringify(t);return this.rawSet(r,s)};remove=async e=>{let t=this.getNamespacedKey(e);return this.rawRemove(t)};setNamespace=e=>{this.keyNamespace=e};parseValue=async e=>{try{if(e!==void 0)return JSON.parse(e)}catch(t){console.error(t)}}};function R(a,e){let t=typeof a=="object",r=t?a.key:a,[s,n]=(0,i.useState)(e),o=(0,i.useRef)(!1),l=(0,i.useRef)(e instanceof Function?e():e);(0,i.useEffect)(()=>{l.current=s},[s]);let h=(0,i.useRef)(t?a.instance:new y),u=(0,i.useCallback)(c=>h.current.set(r,c!==void 0?c:l.current),[r]),p=(0,i.useCallback)(async c=>{let g=c instanceof Function?c(l.current):c;await u(g),o.current&&n(g)},[u]);(0,i.useEffect)(()=>{o.current=!0;let c={[r]:g=>{o.current&&n(g.newValue)}};return h.current.watch(c),h.current.get(r)?.then(g=>{if(e instanceof Function){let S=e?.(g,!0);S!==void 0&&p(S)}else n(g!==void 0?g:e)}),()=>{o.current=!1,h.current.unwatch(c),e instanceof Function&&n(e)}},[r,p]);let m=(0,i.useCallback)(()=>{h.current.remove(r),n(void 0)},[r]);return[s,p,{setRenderValue:n,setStoreValue:u,remove:m}]}0&&(module.exports={useStorage});
