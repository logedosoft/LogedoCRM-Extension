import y from"pify";var l=()=>{try{let e=(globalThis.navigator?.userAgent).match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(e[1]==="Chrome")return parseInt(e[2])<100||globalThis.chrome.runtime?.getManifest()?.manifest_version===2}catch{return!1}return!1};var o=class{#a;#e;get primaryClient(){return this.#e}#t;get secondaryClient(){return this.#t}#r;get area(){return this.#r}get hasWebApi(){try{return typeof window<"u"&&!!window.localStorage}catch(e){return console.error(e),!1}}#s=new Map;#i;get copiedKeySet(){return this.#i}isCopied=e=>this.hasWebApi&&(this.allCopied||this.copiedKeySet.has(e));#n=!1;get allCopied(){return this.#n}getExtStorageApi=()=>globalThis.browser?.storage||globalThis.chrome?.storage;get hasExtensionApi(){try{return!!this.getExtStorageApi()}catch(e){return console.error(e),!1}}isWatchSupported=()=>this.hasExtensionApi;keyNamespace="";isValidKey=e=>e.startsWith(this.keyNamespace);getNamespacedKey=e=>`${this.keyNamespace}${e}`;getUnnamespacedKey=e=>e.slice(this.keyNamespace.length);constructor({area:e="sync",allCopied:t=!1,copiedKeyList:s=[]}={}){this.setCopiedKeySet(s),this.#r=e,this.#n=t;try{this.hasWebApi&&(t||s.length>0)&&(this.#t=window.localStorage)}catch{}try{this.hasExtensionApi&&(this.#a=this.getExtStorageApi(),l()?this.#e=y(this.#a[this.area],{exclude:["getBytesInUse"],errorFirst:!1}):this.#e=this.#a[this.area])}catch{}}setCopiedKeySet(e){this.#i=new Set(e)}rawGetAll=()=>this.#e?.get();getAll=async()=>{let e=await this.rawGetAll();return Object.entries(e).filter(([t])=>this.isValidKey(t)).reduce((t,[s,a])=>(t[this.getUnnamespacedKey(s)]=a,t),{})};copy=async e=>{let t=e===void 0;if(!t&&!this.copiedKeySet.has(e)||!this.allCopied||!this.hasExtensionApi)return!1;let s=this.allCopied?await this.rawGetAll():await this.#e.get((t?[...this.copiedKeySet]:[e]).map(this.getNamespacedKey));if(!s)return!1;let a=!1;for(let r in s){let i=s[r],n=this.#t?.getItem(r);this.#t?.setItem(r,i),a||=i!==n}return a};rawGet=async e=>this.hasExtensionApi?(await this.#e.get(e))[e]:this.isCopied(e)?this.#t?.getItem(e):null;rawSet=async(e,t)=>(this.isCopied(e)&&this.#t?.setItem(e,t),this.hasExtensionApi&&await this.#e.set({[e]:t}),null);clear=async(e=!1)=>{e&&this.#t?.clear(),await this.#e.clear()};rawRemove=async e=>{this.isCopied(e)&&this.#t?.removeItem(e),this.hasExtensionApi&&await this.#e.remove(e)};removeAll=async()=>{let e=await this.getAll(),t=Object.keys(e);await Promise.all(t.map(this.remove))};watch=e=>{let t=this.isWatchSupported();return t&&this.#o(e),t};#o=e=>{for(let t in e){let s=this.getNamespacedKey(t),a=this.#s.get(s)?.callbackSet||new Set;if(a.add(e[t]),a.size>1)continue;let r=(i,n)=>{if(n!==this.area||!i[s])return;let h=this.#s.get(s);if(!h)throw new Error(`Storage comms does not exist for nsKey: ${s}`);Promise.all([this.parseValue(i[s].newValue),this.parseValue(i[s].oldValue)]).then(([p,d])=>{for(let m of h.callbackSet)m({newValue:p,oldValue:d},n)})};this.#a.onChanged.addListener(r),this.#s.set(s,{callbackSet:a,listener:r})}};unwatch=e=>{let t=this.isWatchSupported();return t&&this.#c(e),t};#c(e){for(let t in e){let s=this.getNamespacedKey(t),a=e[t],r=this.#s.get(s);r&&(r.callbackSet.delete(a),r.callbackSet.size===0&&(this.#s.delete(s),this.#a.onChanged.removeListener(r.listener)))}}unwatchAll=()=>this.#h();#h(){this.#s.forEach(({listener:e})=>this.#a.onChanged.removeListener(e)),this.#s.clear()}async getItem(e){return this.get(e)}async setItem(e,t){await this.set(e,t)}async removeItem(e){return this.remove(e)}},g=class extends o{get=async e=>{let t=this.getNamespacedKey(e),s=await this.rawGet(t);return this.parseValue(s)};set=async(e,t)=>{let s=this.getNamespacedKey(e),a=JSON.stringify(t);return this.rawSet(s,a)};remove=async e=>{let t=this.getNamespacedKey(e);return this.rawRemove(t)};setNamespace=e=>{this.keyNamespace=e};parseValue=async e=>{try{if(e!==void 0)return JSON.parse(e)}catch(t){console.error(t)}}};export{o as BaseStorage,g as Storage};
